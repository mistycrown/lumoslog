# 日志压缩优化说明

## 优化时间: 2025-12-09 11:02

### 问题背景
- 8小时工作日,每60秒截图 = 约480条记录
- 每条记录约50-100 tokens
- 总计: 24,000-48,000 tokens ❌ (超过大部分模型上下文限制)

### 解决方案: 智能日志压缩

#### 1. 表格格式导出
**之前的格式**（重复且冗长）:
```
**[08:24:41]** <|begin_of_box|>操作屏幕日志记录器<|end_of_box|>
  - 窗口: LumosLog - AI Screen Logger
  - 应用: python.exe
```

**现在的格式**（精简表格）:
```markdown
| 时间 | 窗口 | 应用 | 日志 |
| --- | --- | --- | --- |
| 08:24:41 | LumosLog - AI Screen Logger | python.exe | 操作屏幕日志记录器 |
```

#### 2. 智能压缩算法

**步骤1: 过滤无效记录**
- 过滤"同上(静止)"
- 过滤"API Key 缺失"
- 过滤"分析失败"的记录

**步骤2: 合并相似活动**
判断标准:
1. 窗口标题必须相同
2. 进程名必须相同
3. 活动描述相似度 >= 50% (Jaccard相似度算法)

合并结果:
```
原始:
| 09:00:15 | VSCode | Code.exe | 编写Python代码 - 实现日志压缩功能 |
| 09:01:20 | VSCode | Code.exe | 编写Python代码 - 添加相似度判断 |
| 09:02:30 | VSCode | Code.exe | 编写Python代码 - 测试压缩效果 |

压缩后:
| 09:00:15 - 09:02:30 | VSCode | Code.exe | 编写Python代码 - 实现日志压缩功能 |
```

#### 3. 压缩效果

**预期效果**:
- 原始: ~480条记录
- 压缩后: ~50-100条记录
- **压缩率: 80-90% token节省** ✅

**实际统计**:
程序会在日志中显示:
```
[INFO] 日志压缩: 480条 → 65条 (压缩率: 13.5%)
```

#### 4. 使用场景

两个功能都会自动应用压缩:

1. **生成今日日报** - 自动压缩后发送给AI
2. **复制日志+Prompt** - 复制压缩后的内容到剪贴板

#### 5. 代码实现

新增函数:
- `compress_logs(logs)` - 主压缩逻辑
- `_is_similar_activity(log1, log2)` - 相似度判断

修改函数:
- `generate_report()` - 使用压缩后的日志
- `copy_log_with_prompt()` - 使用压缩后的日志
